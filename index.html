<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Endless Scroll</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/material-refresh.css"/>
    <style>
    .body-list {
        -webkit-user-select: none; /* 禁用选择文本 */
        -webkit-touch-callout: none; /* (iOS)禁用手机上长按呼出"右键菜单", 例如另存图片之类的 */
        -webkit-overflow-scrolling: touch; /* (iOS)激活原生浏览器滚动条的惯性滚动 */
    }
    .endless-list-wrapper {
        padding: 10px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 40px;
        overflow: auto;
    }
    .app-ft {
        position: absolute;
        right: 0;
        bottom: 0;
        left: 0;
        padding: 10px;
    }
    </style>
    <!--
    参考
    https://github.com/fredwu/jquery-endless-scroll/
    https://github.com/zippy1978/jquery.scrollz
    http://waynepan.com/2010/07/30/javascript-pull-to-refresh/
    https://github.com/lightningtgc/material-refresh/
    -->
</head>
<body class="body-list">
    <div class="endless-list-wrapper">
        <div class="list-group">
            <div class="list-group-item">
                <div class="media">
                    <div class="media-left">
                        <a href="#"><img class="media-object" src="http://www.placehold.it/80x80"></a>
                    </div>
                    <div class="media-body">
                        <h4 class="media-heading">从前有座山</h4>
                        <p>山里有座庙</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="app-ft bg-primary">Endless Scroll</div>

    <script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://apps.bdimg.com/libs/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="https://rawgit.com/ufologist/jquery-endless-scroll/master/js/jquery.endless-scroll.js"></script>
    <script src="js/material-refresh.js"></script>
    <script>
    var $listGroupItem = $('.list-group-item');
    var $listGroup = $('.list-group');
    var i = 0;
    function mockList(length, clear) {
        if (clear) {
            i = 0;
            $listGroup.empty();
        }

        length = i + length;
        for (; i < length; i++) {
            var $clone = $listGroupItem.clone();
            var text = $clone.text();
            $clone.find('.media-heading').text(text + i);
            $listGroup.append($clone);
        }
    }
    mockList(20, true);

    function refreshList() {
        console.log('新的数据加载出来了...');
        mockList(20, true);
        mRefresh.resolve();
        $('.endless-list-wrapper').trigger($.fn.endlessScroll.Constructor.events.RESET);
    }

    function loadNextPage(nextPage) {
        setTimeout(function() {
            if (nextPage == 3) {
                $('.endless-list-wrapper').trigger($.fn.endlessScroll.Constructor.events.ALL_DONE);
            }
            mockList(10);
            $('.endless-list-wrapper').trigger($.fn.endlessScroll.Constructor.events.LOADING_MORE_FINISH);
        }, 2000);
    }

    mRefresh({
        scrollEl: '.endless-list-wrapper',
        maxTime: 20000,
        freeze: false,
        onBegin: function() {
            console.log('这里做数据的刷新逻辑, 一般是ajax');
            // 这里的setTimeout仅用于示例数据加载需要一定的时间
            // 真实的业务逻辑一般是ajax
            setTimeout(refreshList, 3000);
        }
    });

    $('.endless-list-wrapper').endlessScroll();
    $('.endless-list-wrapper').on($.fn.endlessScroll.Constructor.events.REACH_SCROLLBAR_END, function(event, param) {
        var nextPage = param.page + 1;
        console.log('当前是第' + param.page + '页', '开始加载第' + nextPage + '页')
        loadNextPage(nextPage);
    });
    </script>
</body>
</html>
